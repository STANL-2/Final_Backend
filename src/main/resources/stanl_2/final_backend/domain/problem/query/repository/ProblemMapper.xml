<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="stanl_2.final_backend.domain.problem.query.repository.ProblemMapper">

    <resultMap id="Problem" type="stanl_2.final_backend.domain.problem.query.dto.ProblemDTO">
        <id property="problemId" column="PROB_ID"/>
        <result property="title" column="PROB_TTL"/>
        <result property="content" column="PROB_CONT"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="deletedAt" column="DELETED_AT"/>
        <result property="active" column="ACTIVE"/>
        <result property="customerId" column="CUST_ID"/>
        <result property="memberId" column="MEM_ID"/>
        <result property="productId" column="PROD_ID"/>
    </resultMap>

    <resultMap id="SearchProblem" type="stanl_2.final_backend.domain.problem.query.dto.ProblemDTO">
        <id property="noticeId" column="NOT_ID"/>
        <result property="title" column="NOT_TTL"/>
        <result property="memberId" column="NOT_TTL"/>
        <result property="productId" column="NOT_TTL"/>
        <result property="customerId" column="NOT_TTL"/>
    </resultMap>


    <select id="findNotices" resultMap="Problem" parameterType="String" >
        SELECT
        A.prob_id,
        A.prob_ttl,
        A.prob_cont,
        A.created_at,
        A.updated_at,
        A.deleted_at,
        A.active,
        A.cust_id,
        A.mem_id,
        A.prod_id
        FROM tb_problem A
        <where>
            a.active != 'false'
            <if test="problemSearchDTO.tag != null">
                AND A.NOT_TAG = #{searchDTO.tag}
            </if>
            <if test="searchDTO.classification != null">
                AND A.NOT_CLA = #{searchDTO.classification}
            </if>
            <if test="searchDTO.memberId != null">
                AND A.MEM_ID = #{searchDTO.memberId}
            </if>
            <if test="searchDTO.title != null">
                AND A.NOT_TTL LIKE CONCAT('%', #{searchDTO.title}, '%')
            </if>
            <if test="searchDTO.startDate != null and searchDTO.endDate != null">
                AND A.CREATED_AT BETWEEN #{searchDTO.startDate} AND #{searchDTO.endDate}
            </if>
        </where>
        ORDER BY A.CREATED_AT DESC
        LIMIT #{size} OFFSET #{offset}
    </select>


    <select id="findNoticesCount" resultMap="SearchNotice" parameterType="String">
        SELECT
        COUNT(*) AS CNT
        FROM TB_NOTICE A
        <where>
            A.ACTIVE != 'false'
            <if test="tag != null">
                AND A.NOT_TAG = #{tag}
            </if>
            <if test="classification != null">
                AND A.NOT_CLA = #{classification}
            </if>
            <if test="memberId != null">
                AND A.MEM_ID = #{memberId}
            </if>
            <if test="title != null">
                AND A.NOT_TTL = #{title}
            </if>
            <if test="startDate != null and endDate != null">
                AND A.CREATED_AT BETWEEN #{startDate} AND #{endDate}
            </if>
        </where>
    </select>

    <select id="findNotice" resultMap="Notice" parameterType="string">
        SELECT
        A.NOT_ID,
        A.NOT_TTL,
        A.NOT_TAG,
        A.NOT_CLA,
        A.NOT_CONT,
        A.CREATED_AT,
        A.UPDATED_AT,
        A.DELETED_AT,
        A.ACTIVE,
        A.MEM_ID
        FROM TB_NOTICE A
        WHERE NOT_ID = #{noticeId};
    </select>

</mapper>