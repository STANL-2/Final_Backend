<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="stanl_2.final_backend.domain.contract.query.repository.ContractMapper">

    <resultMap id="contractResultMap" type="stanl_2.final_backend.domain.contract.query.dto.ContractSeletIdDTO">
        <id property="contractId" column="CONR_ID"/>
        <result property="title" column="CONR_TTL"/>
        <result property="customerName" column="CONR_CUST_NAME"/>
        <result property="customerIdentifiNo" column="CONR_CUST_IDEN_NO"/>
        <result property="customerAddrress" column="CONR_CUST_ADR"/>
        <result property="customerEmail" column="CONR_CUST_EMA"/>
        <result property="customerPhone" column="CONR_CUST_PHO"/>
        <result property="companyName" column="CONR_COMP_NAME"/>
        <result property="customerClassifcation" column="CONR_CUST_CLA"/>
        <result property="customerPurchaseCondition" column="CONR_CUST_PUR_COND"/>
        <result property="serialNum" column="CONR_SERI_NUM"/>
        <result property="selectOption" column="CONR_SELE_OPTI"/>
        <result property="downPayment" column="CONR_DOWN_PAY"/>
        <result property="intermediatePayment" column="CONR_INTE_PAY"/>
        <result property="remainderPayment" column="CONR_REM_PAY"/>
        <result property="consignmentPayment" column="CONR_CONS_PAY"/>
        <result property="delveryDate" column="CONR_DELV_DATE"/>
        <result property="delveryLocation" column="CONR_DELV_LOC"/>
        <result property="status" column="CONR_STAT"/>
        <result property="numberOfVehicles" column="CONR_NO_OF_VEH"/>
        <result property="totalSales" column="CONR_TOTA_SALE"/>
        <result property="createdUrl" column="CREATED_URL"/>
        <result property="deletedUrl" column="DELETED_URL"/>
        <result property="active" column="ACTIVE"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="deletedAt" column="DELETED_AT"/>
        <result property="memberId" column="MEM_ID"/>
        <result property="centerId" column="CENT_ID"/>
        <result property="customerId" column="CUST_ID"/>
        <result property="productId" column="PROD_ID"/>
        <result property="carName" column="CONR_CAR_NAME"/>
    </resultMap>

    <resultMap id="contractSearchResultMap" type="stanl_2.final_backend.domain.contract.query.dto.ContractSearchDTO">
        <id property="contractId" column="CONR_ID"/>
        <result property="title" column="CONR_TTL"/>
        <result property="customerName" column="CONR_CUST_NAME"/>
        <result property="companyName" column="CONR_COMP_NAME"/>
        <result property="customerClassifcation" column="CONR_CUST_CLA"/>
        <result property="customerPurchaseCondition" column="CONR_CUST_PUR_COND"/>
        <result property="selectOption" column="CONR_SELE_OPTI"/>
        <result property="status" column="CONR_STAT"/>
        <result property="active" column="ACTIVE"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="deletedAt" column="DELETED_AT"/>
        <result property="memberId" column="MEM_ID"/>
        <result property="centerId" column="CENT_ID"/>
        <result property="customerId" column="CUST_ID"/>
        <result property="productId" column="PROD_ID"/>
        <result property="productName" column="PROD_NAME" />
        <result property="carName" column="CONR_CAR_NAME"/>
    </resultMap>

    <resultMap id="contractAllResultMap" type="stanl_2.final_backend.domain.contract.query.dto.ContractSelectAllDTO">
        <id property="contractId" column="CONR_ID"/>
        <result property="title" column="CONR_TTL"/>
        <result property="customerName" column="CONR_CUST_NAME"/>
        <result property="companyName" column="CONR_COMP_NAME"/>
        <result property="status" column="CONR_STAT"/>
        <result property="createdUrl" column="CREATED_URL"/>
        <result property="deletedUrl" column="DELETED_URL"/>
        <result property="active" column="ACTIVE"/>
        <result property="memberId" column="MEM_ID"/>
        <result property="centerId" column="CENT_ID"/>
        <result property="customerId" column="CUST_ID"/>
        <result property="productId" column="PROD_ID"/>
        <result property="productName" column="PROD_NAME" />
        <result property="carName" column="CONR_CAR_NAME"/>
    </resultMap>

    <select id="findContractByIdAndMemId" resultMap="contractResultMap" parameterType="hashmap">
        SELECT
        a.conr_id,
        a.conr_ttl,
        a.conr_cust_name,
        a.conr_cust_iden_no,
        a.conr_cust_adr,
        a.conr_cust_ema,
        a.conr_cust_pho,
        a.conr_comp_name,
        a.conr_cust_cla,
        a.conr_cust_pur_cond,
        a.conr_seri_num,
        a.conr_sele_opti,
        a.conr_down_pay,
        a.conr_inte_pay,
        a.conr_rem_pay,
        a.conr_cons_pay,
        a.conr_delv_date,
        a.conr_delv_loc,
        a.conr_stat,
        a.conr_no_of_veh,
        a.conr_tota_sale,
        a.conr_car_name,
        a.created_url,
        a.created_at,
        a.updated_at,
        a.active,
        a.cent_id,
        a.cust_id,
        a.prod_id,
        a.mem_id
        FROM tb_contract a
        WHERE a.conr_id = #{ contractId }
        AND a.mem_id = #{ memberId }
        AND a.active = TRUE;
    </select>

    <select id="findContractById" resultMap="contractResultMap" parameterType="string">
        SELECT
        a.conr_id,
        a.conr_ttl,
        a.conr_cust_name,
        a.conr_cust_iden_no,
        a.conr_cust_adr,
        a.conr_cust_ema,
        a.conr_cust_pho,
        a.conr_comp_name,
        a.conr_cust_cla,
        a.conr_cust_pur_cond,
        a.conr_seri_num,
        a.conr_sele_opti,
        a.conr_down_pay,
        a.conr_inte_pay,
        a.conr_rem_pay,
        a.conr_cons_pay,
        a.conr_delv_date,
        a.conr_delv_loc,
        a.conr_stat,
        a.conr_no_of_veh,
        a.conr_car_name,
        a.conr_tota_sale,
        a.created_url,
        a.created_at,
        a.updated_at,
        a.active,
        a.cent_id,
        a.cust_id,
        a.prod_id,
        a.mem_id
        FROM tb_contract a
        WHERE a.conr_id = #{ contractId }
        AND a.active = TRUE;
    </select>

    <select id="findContractAllByMemId" resultMap="contractAllResultMap" parameterType="map">
        SELECT
        a.conr_id,
        a.conr_ttl,
        a.conr_cust_name,
        a.conr_comp_name,
        a.conr_car_name,
        a.conr_stat,
        a.created_url,
        a.active
        FROM tb_contract a
        WHERE a.mem_id = #{ memberId }
        AND a.active = TRUE
        ORDER BY a.created_at DESC
        LIMIT #{pageSize} OFFSET #{offset};
    </select>

    <select id="findContractAll" resultMap="contractAllResultMap" parameterType="map">
        SELECT
        a.conr_id,
        a.conr_cust_name,
        a.conr_comp_name,
        a.conr_car_name,
        a.conr_ttl,
        a.conr_stat,
        a.created_url,
        a.conr_cust_pur_cond,
        a.conr_cust_cla,
        a.prod_id
        FROM tb_contract a
        WHERE a.active = TRUE
        ORDER BY a.created_at DESC
        LIMIT #{pageSize} OFFSET #{offset};
    </select>

    <select id="findContractBySearchAndMemberId" resultMap="contractSearchResultMap" parameterType="map">
        SELECT
        a.conr_id,
        a.conr_cust_name,
        a.conr_comp_name,
        a.conr_ttl,
        a.conr_stat,
        a.created_url,
        a.conr_cust_pur_cond,
        a.conr_car_name,
        a.created_at,
        a.updated_at,
        a.deleted_at,
        a.active
        FROM tb_contract a
        <where>
            a.mem_id = #{memberId}
            AND a.active = TRUE
            <if test="centerId != null">
                AND a.cent_id = #{centerId}
            </if>
            <if test="title != null">
                AND a.conr_name LIKE CONCAT('%', #{title}, '%')
            </if>
            <if test="customerName != null">
                AND a.conr_cust_name LIKE CONCAT('%', #{customerName}, '%')
            </if>
            <if test="customerClassifcation != null">
                AND a.conr_cust_cla LIKE CONCAT('%', #{customerClassifcation}, '%')
            </if>
            <if test="status != null">
                AND a.conr_stat = #{status}
            </if>
            <if test="companyName != null">
                AND a.conr_comp_name LIKE CONCAT('%', #{companyName}, '%')
            </if>
            <if test="customerPurchaseCondition != null">
                AND a.conr_cust_pur_cond LIKE CONCAT('%', #{customerPurchaseCondition}, '%')
            </if>
            <if test="startAt != null and endAt != null">
                AND a.created_at BETWEEN #{startAt} AND #{endAt}
            </if>
            <if test="productId != null">
                AND b.prod_name LIKE CONCAT('%', #{productId}, '%')
            </if>
        </where>
        ORDER BY a.created_at DESC
        LIMIT #{pageSize} OFFSET #{offset};
    </select>
    <select id="findContractBySearch" resultMap="contractSearchResultMap" parameterType="map">
        SELECT
        a.conr_id,
        a.conr_cust_name,
        a.conr_ttl,
        a.conr_comp_name,
        a.conr_stat,
        a.created_url,
        a.conr_cust_pur_cond,
        a.conr_car_name,
        a.created_at,
        a.updated_at,
        a.deleted_at,
        a.active
        FROM tb_contract a
        <where>
            a.active = TRUE
            <if test="centerId != null">
                AND a.cent_id = #{centerId}
            </if>
            <if test="title != null">
                AND a.conr_name LIKE CONCAT('%', #{title}, '%')
            </if>
            <if test="customerName != null">
                AND a.conr_cust_name LIKE CONCAT('%', #{customerName}, '%')
            </if>
            <if test="customerClassifcation != null">
                AND a.conr_cust_cla LIKE CONCAT('%', #{customerClassifcation}, '%')
            </if>
            <if test="status != null">
                AND a.conr_stat = #{status}
            </if>
            <if test="companyName != null">
                AND a.conr_comp_name LIKE CONCAT('%', #{companyName}, '%')
            </if>
            <if test="customerPurchaseCondition != null">
                AND a.conr_cust_pur_cond LIKE CONCAT('%', #{customerPurchaseCondition}, '%')
            </if>
            <if test="startAt != null and endAt != null">
                AND a.created_at BETWEEN #{startAt} AND #{endAt}
            </if>
            <if test="productId != null">
                AND b.prod_name LIKE CONCAT('%', #{productId}, '%')
            </if>
        </where>
        ORDER BY a.created_at DESC
        LIMIT #{pageSize} OFFSET #{offset};
    </select>

    <select id="findContractCountByMemId" resultType="int">
        SELECT
        COUNT(*) AS cnt
        FROM tb_contract a
        WHERE a.mem_id = #{ memberId }
        AND a.active = TRUE;
    </select>

    <select id="findContractCount" resultType="int">
        SELECT
        COUNT(*) AS cnt
        FROM tb_contract a
        WHERE a.active = TRUE;
    </select>

    <select id="findContractBySearchAndMemberIdCount" resultType="int" parameterType="map">
        SELECT COUNT(*)
        FROM tb_contract a
        <where>
            a.mem_id = #{memId}
            AND a.active = TRUE
            <if test="centerId != null">
                AND a.cent_id = #{centerId}
            </if>
            <if test="title != null">
                AND a.conr_name LIKE CONCAT('%', #{title}, '%')
            </if>
            <if test="customerName != null">
                AND a.conr_cust_name LIKE CONCAT('%', #{customerName}, '%')
            </if>
            <if test="customerClassifcation != null">
                AND a.conr_cust_cla LIKE CONCAT('%', #{customerClassifcation}, '%')
            </if>
            <if test="status != null">
                AND a.conr_stat = #{status}
            </if>
            <if test="companyName != null">
                AND a.conr_comp_name LIKE CONCAT('%', #{companyName}, '%')
            </if>
            <if test="customerPurchaseCondition != null">
                AND a.conr_cust_pur_cond LIKE CONCAT('%', #{customerPurchaseCondition}, '%')
            </if>
            <if test="startAt != null and endAt != null">
                AND a.created_at BETWEEN #{startAt} AND #{endAt}
            </if>
            <if test="productId != null">
                AND b.prod_name LIKE CONCAT('%', #{productId}, '%')
            </if>
        </where>;
    </select>

    <select id="findContractBySearchCount" resultType="int" parameterType="map">
        SELECT COUNT(*)
        FROM tb_contract a
        <where>
            a.active = TRUE
            <if test="centerId != null">
                AND a.cent_id = #{centerId}
            </if>
            <if test="title != null">
                AND a.conr_name LIKE CONCAT('%', #{title}, '%')
            </if>
            <if test="customerName != null">
                AND a.conr_cust_name LIKE CONCAT('%', #{customerName}, '%')
            </if>
            <if test="customerClassifcation != null">
                AND a.conr_cust_cla LIKE CONCAT('%', #{customerClassifcation}, '%')
            </if>
            <if test="status != null">
                AND a.conr_stat = #{status}
            </if>
            <if test="companyName != null">
                AND a.conr_comp_name LIKE CONCAT('%', #{companyName}, '%')
            </if>
            <if test="customerPurchaseCondition != null">
                AND a.conr_cust_pur_cond LIKE CONCAT('%', #{customerPurchaseCondition}, '%')
            </if>
            <if test="startAt != null and endAt != null">
                AND a.created_at BETWEEN #{startAt} AND #{endAt}
            </if>
            <if test="productId != null">
                AND b.prod_name LIKE CONCAT('%', #{productId}, '%')
            </if>
        </where>;
    </select>
</mapper>